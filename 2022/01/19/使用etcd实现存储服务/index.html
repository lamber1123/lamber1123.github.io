<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="msvalidate.01" content="D5358D241F26545F49E55D403F921D5D"><meta name="google-site-verification" content="7h0jWlXl61CeDREpTs47QhQ9Qz7CJptnpSUcrIxB_II"><meta name="baidu-site-verification" content="code-Ob43MMYNMI"><title>使用etcd实现存储服务 - Lamber&#039;s Blog: Lamber的个人博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lamber&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lamber&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="etcd server与raft的交互 WAL backend store的实现 applierV3"><meta property="og:type" content="blog"><meta property="og:title" content="使用etcd实现存储服务"><meta property="og:url" content="https://lameber1123.github.io/"><meta property="og:site_name" content="Lamber&#039;s Blog"><meta property="og:description" content="etcd server与raft的交互 WAL backend store的实现 applierV3"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-server.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-flowchart.png"><meta property="og:image" content="https://lameber1123.github.io/etcd-wal1.png"><meta property="og:image" content="https://lameber1123.github.io/etcd-wal2.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-snapshot.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-keyindex.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-keyindex-struct.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-generation-compact.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-lease-store.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-store-put.png"><meta property="og:image" content="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-raft-flow.png"><meta property="article:published_time" content="2022-01-19T08:28:21.000Z"><meta property="article:modified_time" content="2022-10-17T08:02:04.026Z"><meta property="article:author" content="Lamber"><meta property="article:tag" content="Raft"><meta property="article:tag" content="分布式"><meta property="article:tag" content="etcd"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-server.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://lameber1123.github.io"},"headline":"使用etcd实现存储服务","image":["https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-server.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-flowchart.png","https://lameber1123.github.io/etcd-wal1.png","https://lameber1123.github.io/etcd-wal2.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-snapshot.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-keyindex.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-keyindex-struct.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-generation-compact.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-lease-store.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-store-put.png","https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-raft-flow.png"],"datePublished":"2022-01-19T08:28:21.000Z","dateModified":"2022-10-17T08:02:04.026Z","author":{"@type":"Person","name":"Lamber"},"publisher":{"@type":"Organization","name":"Lamber's Blog","logo":{"@type":"ImageObject","url":"https://lameber1123.github.io/img/logo.png"}},"description":"etcd server与raft的交互 WAL backend store的实现 applierV3"}</script><link rel="canonical" href="https://lameber1123.github.io/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="/css/font.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?4edd89be4e1594bf8520dcaf7b48bcce";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script type="text/javascript" src="/js/clicklove.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Lamber&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/lamber1123"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-01-19T08:28:21.000Z" title="2022/1/19 下午4:28:21">2022-01-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-10-17T08:02:04.026Z" title="2022/10/17 下午4:02:04">2022-10-17</time></span><span class="level-item"><a class="link-muted" href="/categories/Raft%E7%AC%94%E8%AE%B0/">Raft笔记</a></span><span class="level-item">36 minutes read (About 5413 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">使用etcd实现存储服务</h1><div class="content"><ul>
<li>etcd server与raft的交互</li>
<li>WAL</li>
<li>backend store的实现</li>
<li>applierV3</li>
</ul>
<span id="more"></span>

<hr>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#p1">1. 概述</a></li>
<li><a href="#p2">2. etcd server与raft的交互</a></li>
<li><a href="#p3">3. WAL</a></li>
<li><a href="#p4">4. backend store的实现</a><ul>
<li><a href="#p4_1">4.1 revision概念</a></li>
<li><a href="#p4_2">4.2 keyIndex结构</a></li>
<li><a href="#p4_3">4.3 treeIndex结构</a></li>
<li><a href="#p4_4">4.4 store</a></li>
<li><a href="#p4_5">4.5 KV接口</a></li>
</ul>
</li>
<li><a href="#p5">5. applierV3</a></li>
<li><a href="#p6">6. 综述</a></li>
</ul>
<hr>
<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a><p id="p1">1. 概述</p></h2><p>这篇笔记是继解析Raft算法原理及etcd Raft库解析的第三篇笔记，这篇笔记依旧是在codedump的网络日志基础之上记录的。在这篇笔记我们接着分析etcd如何使用Raft实现存储服务的。</p>
<p>这篇笔记的分析主要针对etcd V3版本的实现，下图中展示了etcd如何处理一个客户端请求的涉及到的模块和流程，其中两个大模块为：</p>
<ul>
<li>etcd server：对外接收客户端的请求，对应etcd代码中的etcdserver目录，其中还有一个raft.go的模块与etcd-raft库进行通信。etcdserver中与存储相关的模块是applierV3，这里封装了V3版本的数据存储，WAL（write ahead log），用于写数据日志，etcd启动时会根据这部分内容进行恢复。</li>
<li>etcd raft：etcd的raft库，前面的文章已经具体分析过这部分代码。除了与本节点的etcd server通信之外，还与集群中的其他etcd server进行交互做一致性数据同步的工作。</li>
</ul>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-server.png" alt="etcd-server"></p>
<p>在上图中，一个请求与一个etcd集群交互的主要流程分为两大部分：</p>
<ol>
<li>写数据到某个etcd server中。</li>
<li>该etcd server与集群中的其他etcd节点进行交互，当确保数据已经被存储之后应答客户端。</li>
</ol>
<p>请求流程划分为了以下的子步骤：</p>
<ul>
<li>1.1：etcd server收到客户端请求。</li>
<li>1.2：etcd server将请求发送给本模块中的raft.go，这里负责与etcd raft模块进行通信。</li>
<li>1.3：raft.go将数据封装成raft日志的形式提交给raft模块。</li>
<li>1.4：raft模块会首先保存到raftLog的unstable存储部分。</li>
<li>1.5：raft模块通过raft协议与集群中其他etcd节点进行交互。</li>
</ul>
<p>注意在以上流程中，假设这里写入数据的etcd是leader节点，因为在raft协议中，如果提交数据到非leader节点的话需要路由到etcd leader节点去。而应答步骤如下：</p>
<ul>
<li>2.1：集群中其他节点向leader节点应答接收这条日志数据。</li>
<li>2.2：当超过集群半数以上节点应答接收这条日志数据时，etcd raft通过Ready结构体通知etcd server中的raft该日志数据已经commit。</li>
<li>2.3：raft.go收到Ready数据将首先将这条日志写入到WAL模块中。</li>
<li>2.4：通知最上层的etcd server该日志已经commit。</li>
<li>2.5：etcd server调用applierV3模块将日志写入持久化存储中。</li>
<li>2.6：etcd server应答客户端该数据写入成功。</li>
<li>2.7：最后etcd server调用etcd raft，修改其raftLog模块的数据，将这条日志写入到raftLog的storage中。</li>
</ul>
<p>从上面的流程可以看到：</p>
<ul>
<li>etcd raft模块在应答某条日志数据已经commit之后，是首先写入到WAL模块中的，因为这个模块只是添加一条日志，所以速度会很快，即使在后面applierV3写入失败，重启的时候也可以根据WAL模块中的日志数据进行恢复。</li>
<li>etcd raft中的raftLog，按照前面文章的分析，其中的数据是保存到内存中的，重启即失效，上层应用真实的数据是持久化保存到WAL和applierV3中的。</li>
</ul>
<p>以下就来分析etcd server与这部分相关的几个模块。</p>
<hr>
<h2 id="2-etcd-server与raft的交互"><a href="#2-etcd-server与raft的交互" class="headerlink" title="2. etcd server与raft的交互"></a><p id="p2">2. etcd server与raft的交互</p></h2><p>EtcdServer 结构体，负责对外与客户端进行通信。内部有一个 raftNode 结构的成员，负责与etcd的raft库进行交互。</p>
<p>etcd V3版本的API，通过GRPC协议与客户端进行交互，其相关代码在 etcdserver/v3_server.go 中。以一次Put请求为例，最后将会调用的代码在函数 EtcdServer::processInternalRaftRequestOnce 中，代码的主要流程分析如下：</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-flowchart.png" alt="etcd flowchart"></p>
<ol>
<li>拿到当前raft中的apply和commit索引，如果commit索引比apply索引超出太多，说明当前有很多数据都没有apply，返回 ErrTooManyRequests 错误。</li>
<li>调用 s.reqIDGen.Next() 函数生成一个针对当前请求的ID，注意这个ID并不是一个随机数而是一个严格递增的整数。同时将请求序列化为byte数据，这会做为raft的数据进行存储。</li>
<li>根据第2步中的ID，调用 Wait.Register 函数进行注册，这会返回一个用于通知结果的channel，后续就通过监听该channel来确定是否成功储存了提交的值。</li>
<li>调用 Raft.Process 函数提交数据，这里传入的参数除了前面序列化的数据之外，还有使用超时时间创建的Context。</li>
<li>监听前面的Channel以及Context对象：<br> a. 如果 context.Done 返回，说明数据提交超时，使用 s.parseProposeCtxErr 函数返回具体的错误。<br> b. 如果channel返回，说明已经提交成功。</li>
</ol>
<p>从以上的流程可以看出，在调用 Raft.Process 函数向Raft库提交数据之后，等待被唤醒的Channel才是正常提交数据成功的路径。</p>
<p>在 EtcdServer.run 函数中，最终会进入一个死循环中，等待 raftNode.apply 返回的channel被唤醒，而raftNode继承了 raft.Node 的实现，从前面分析etcd raft的流程中可以明白，EtcdServer就是在向raft库提交了数据之后，做为其上层消费Ready数据的应用层。</p>
<p>自此，整体的流程大体如下：</p>
<ol>
<li>EtcdServer对外通过GRPC协议接收客户端请求，对内有一个raftNode类型的成员，该类型继承了raft.Node的实现。</li>
<li>客户端通过EtcdServer提交的数据修改都会通过raftNode来提交，而EtcdServer本身通过监听channel与raft库进行通信，由Ready结构体来通过EtcdServer哪些数据已经提交成功。</li>
<li>由于每个请求都会一个对应的ID，ID绑定了Channel，所以提交成功的请求通过ID找到对应的Channel来唤醒提交流程，最后通知客户端提交数据成功。</li>
</ol>
<hr>
<h2 id="3-WAL"><a href="#3-WAL" class="headerlink" title="3. WAL"></a><p id="p3">3. WAL</p></h2><p>以上介绍了EtcdServer的大体流程，接下来看WAL的实现。</p>
<p>前面已经分析过了，etcd raft提交数据成功之后，将通知上面的应用层（在这里就是EtcdServer），然后再进行持久化数据存储。而数据的持久化可能会花费一些时间，因此在应答应用层之前，EtcdServer中的raftNode会首先将这些数据写入WAL日志中。这样即使在做持久化的时候数据丢失了，启动恢复的时候也可以根据WAL的日志进行数据恢复。</p>
<p>etcdserver模块中，给raftNode用于写WAL日志的工作，交给了接口Storage来完成，而这个接口由storage来具体实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> storage <span class="keyword">struct</span> &#123;</span><br><span class="line">	*wal.WAL</span><br><span class="line">	*snap.Snapshotter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这个结构体组合了WAL和snap.Snapshotter结构，Snapshotter负责的是存储快照数据。</p>
<p>WAL日志文件中，每条日志记录有以下的类型：</p>
<ul>
<li>Type：日志记录类型，下面详细解释都有哪些类型。</li>
<li>Crc：这一条日志记录的校验数据。</li>
<li>Data：真正的数据，根据类型不同存储的数据也不同。</li>
</ul>
<p>日志记录又有如下的类型：</p>
<ul>
<li>metadataType：存储的是元数据（metadata），每个WAL文件开头都有这类型的一条记录数据。</li>
<li>entryType：保存的是raft的数据，也就是客户端提交上来并且已经commit的数据。</li>
<li>stateType：保存的是当前集群的状态信息，即前面提到的HardState。</li>
<li>crcType：校验数据。</li>
<li>snapshotType：快照数据。</li>
</ul>
<p>etcd使用两个目录分别存放WAL文件以及快照文件。其中，WAL文件的文件名格式是“16位的WAL文件编号-该WAL第一条entry数据的index号.wal”，这样就能从WAL文件名知道该WAL文件中保存的entry数据至少大于什么索引号。而快照文件名的格式则是“16位的快照数据最后一条日志记录任期号-16位的快照数据最后一条记录的索引号.snap”。</p>
<p>Etcd会管理WAL目录中的所有WAL文件，但是在生成快照文件之后，在快照数据之前的WAL文件将被清除掉，保证磁盘不会一直增长。比如当前etcd中有三个WAL文件，可以从这些文件的文件名知道其中存放数据的索引范围。</p>
<p><img src="/etcd-wal1.png" alt="etcd wal1"></p>
<p>在生成快照文件之后，此时就只剩一个WAL文件和一个快照文件了：</p>
<p><img src="/etcd-wal2.png" alt="etcd wal2"></p>
<p>那么，又是在什么情况下生成快照文件呢？Etcdserver在主循环中通过监听channel获知当前raft协议返回的Ready数据，此时会做判断如果当前保存的快照数据索引距离上一次已经超过一个阈值（EtcdServer.snapCount），此时就从raft的存储中生成一份当前的快照数据，写入快照文件成功之后，就可以将这之前的WAL文件释放了。</p>
<p>以上流程和对应的具体函数见下面的流程图：</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-snapshot.png" alt="etcd snapshot"></p>
<hr>
<h2 id="4-backend-store的实现"><a href="#4-backend-store的实现" class="headerlink" title="4. backend store的实现"></a><p id="p4">4. backend store的实现</p></h2><h3 id="4-1-revision概念"><a href="#4-1-revision概念" class="headerlink" title="4.1 revision概念"></a><p id="p4_1">4.1 revision概念</p></h3><p>Etcd存储数据时，并不是像其他的KV存储那样，存放数据的键做为key，而是以数据的revision做为key，键值做为数据来存放。如何理解revision这个概念，将用以下面的例子来说明。</p>
<p>比如通过批量接口两次更新两对键值，第一次写入数据时，写入&lt;key1,value1&gt;和&lt;key2,value2&gt;，在Etcd这边的存储看来，存放的数据就是这样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">revision=&#123;<span class="number">1</span>,<span class="number">0</span>&#125;, key=key1, value=value1</span><br><span class="line">revision=&#123;<span class="number">1</span>,<span class="number">1</span>&#125;, key=key2, value=value2</span><br></pre></td></tr></table></figure>

<p>而在第二次更新写入数据&lt;key1,update1&gt;和&lt;key2,update2&gt;后，存储中又记录（注意不是覆盖前面的数据）了以下数据：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">revision=&#123;<span class="number">2</span>,<span class="number">0</span>&#125;, key=key1, value=update1</span><br><span class="line">revision=&#123;<span class="number">2</span>,<span class="number">1</span>&#125;, key=key2, value=update2</span><br></pre></td></tr></table></figure>

<p>其中revision有两部分组成，第一部分成为<font color="red">main revision</font>，每次事务递增1；第二部分称为<font color="red">sub revision</font>，一个事务内的一次操作递增1。 两者结合，就能保证key的唯一性且单调递增。</p>
<p>但是，客户端是根据Key值来进行操作的，所以需要一个Key映射到当前revision的操作。由此etcd引入了一个内存中的Btree索引，整个操作过程如下面的流程所示：</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-keyindex.png" alt="etcd keyindex"></p>
<p>查询时，先通过内存中的btree索引来查询该key对应的keyIndex结构体，然后再根据这个结构体才能去boltDB中查询真实的数据返回。</p>
<p>所以，下面先展开讨论这个keyIndex结构体和btree索引。</p>
<hr>
<h3 id="4-2-keyIndex结构"><a href="#4-2-keyIndex结构" class="headerlink" title="4.2 keyIndex结构"></a><p id="p4_2">4.2 keyIndex结构</p></h3><p>keyIndex结构体有以下成员：</p>
<ul>
<li>key：存储数据真实的键。</li>
<li>modified：最后一次修改该键对应的revision。</li>
<li>generations：generation数组。</li>
</ul>
<p>如何理解generation结构呢，可以认为每个generation对应一个数据从创建到删除的过程。每次删除key的操作，都会导致一个generation最后添加一个tombstone记录，然后创建一个新的空generation记录添加到generations数组中。</p>
<p>generation结构体存放以下数据：</p>
<ul>
<li>ver：当前generation中存放了多少次修改，其实就是revs数组的大小-1（因为需要去掉tombstone）。</li>
<li>created：创建该generation时的revision。</li>
<li>revs：存放该generation中存放的revision数组。</li>
</ul>
<p>keyIndex结构体如下：</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-keyindex-struct.png" alt="etcd keyindex struct"></p>
<p>如上图所示，存放的键为test的keyIndex结构。它的generations数组有两条记录，其中generations[0]在revision 1.0时创建，当revision2.1的时候进行tombstone操作，因此该generation的created是1.0；对应的generations[1]在revision3.3时创建，紧跟着就做了tombstone操作。</p>
<p>所以该 keyIndex.modifiled 成员存放的是3.3，因为这是这条数据最后一次被修改的revision。一个已经被tombstone的generation是可以被删除的，如果整个generations数组都已经被删除空了，那么整个keyIndex记录也可以被删除了。</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-generation-compact.png" alt="etcd generation compact"></p>
<p>如上图所示，keyIndex.compact(n) 函数可以对keyIndex数据进行压缩操作，将删除满足main revision &lt; n的数据。</p>
<p>compact(2)：找到了generations[0]的1.0 revision的数据进行了删除。<br>compact(3)：找到了generations[0]的2.1 revision的数据进行了删除，此时由于generations[0]已经没有数据了，所以这一整个generation被删除，原先的generations[1]变成了generations[0]。<br>compact(4)：找到了generations[0]的3.3 revision的数据进行了删除。由于所有的generation数据都被删除了，此时这个keyIndex数据可以删除了。</p>
<hr>
<h3 id="4-3-treeIndex结构"><a href="#4-3-treeIndex结构" class="headerlink" title="4.3 treeIndex结构"></a><p id="p4_3">4.3 treeIndex结构</p></h3><p>Etcd中使用treeIndex来在内存中存放keyIndex数据信息，这样就可以快速的根据输入的key定位到对应的keyIndex。</p>
<p>treeIndex使用开源的 <a target="_blank" rel="noopener" href="https://github.com/google/btree">github.com/google/btree</a> 来在内存中存储btree索引信息，因为用的是外部库，所以不打算就这部分做解释。而如果很清楚了前面keyIndex结构，其实这部分很好理解。</p>
<p>所有的操作都以key做为参数进行操作，treeIndex使用btree根据key查找到对应的keyIndex，再进行相关的操作，最后重新写入到btree中。</p>
<hr>
<h3 id="4-4-store"><a href="#4-4-store" class="headerlink" title="4.4 store"></a><p id="p4_4">4.4 store</p></h3><p>前面讲到了WAL数据的存储、内存索引数据的存储，这部分讨论<font color="red">持久化存储数据</font>的模块。</p>
<p>etcd V3版本中，使用BoltDB来持久化存储数据，所以这里先简单解释一下BoltDB中的相关概念。</p>
<h4 id="4-4-1-BoltDB相关概念"><a href="#4-4-1-BoltDB相关概念" class="headerlink" title="4.4.1 BoltDB相关概念"></a>4.4.1 BoltDB相关概念</h4><p>BoltDB中涉及到的几个数据结构，分别为DB、Bucket、Tx、Cursor、Tx：</p>
<ul>
<li>DB：表示数据库，类比于Mysql。</li>
<li>Bucket：数据库中的键值集合，类比于Mysql中的一张数据表。</li>
<li>键值对：BoltDB中实际存储的数据，类比于Mysql中的一行数据。</li>
<li>Cursor：迭代器，用于按顺序遍历Bucket中的键值对。</li>
<li>Tx：表示数据库操作中的一次只读或者读写事务。</li>
</ul>
<h4 id="4-4-2-Backend-与-BackendTx-接口"><a href="#4-4-2-Backend-与-BackendTx-接口" class="headerlink" title="4.4.2 Backend 与 BackendTx 接口"></a>4.4.2 Backend 与 BackendTx 接口</h4><p>Backend和BackendTx内部的实现，封装了BoltDB，在此不做分析。</p>
<h4 id="4-4-3-Lessor接口"><a href="#4-4-3-Lessor接口" class="headerlink" title="4.4.3 Lessor接口"></a>4.4.3 Lessor接口</h4><p>etcd中没有提供针对数据设置过期时间的操作，通过租约（Lease）来实现数据过期的效果。而Lessor就提供了管理租约的相关接口。</p>
<p>比如，使用 etcdctl 命令可以创建一个lease：</p>
<blockquote>
<p>etcdctl lease grant 10 lease 694d67ed2bfbea03 granted with TTL(10s)</p>
</blockquote>
<p>这样就创建了一个ID为694d67ed2bfbea03的Lease，此时可以将键值与这个lease进行绑定：</p>
<blockquote>
<p>etcdctl put –lease=694d67ed2bfbea03 a b</p>
</blockquote>
<p>当时间还没超过过期时间10S时，能通过etcd拿到这对键值的数据。如果超时了就获取不到数据了。从上面的命令可以看出，一个Lease可以与多个键值对应，由这个Lease通过管理与其绑定的键值数据的生命周期。</p>
<p>etcd中，将Lease ID存放在名为“lease”的Bucket中，注意在这里只存放Lease相关的数据，其键值为：&lt;Lease ID，序列化后的Lease数据包括TTL、ID&gt;，之所以不存放与Lease绑定的键值，是因为这些键值已经存放到另外的Bucket里了，写入数据的时候也会将这些键值绑定的Lease ID写入，这样在恢复数据的时候就可以将键值与Lease ID绑定的关系写入内存中。</p>
<p>即：Lease这边需要持久化的数据只有Lease ID与TTL值，而键值对这边会持久化所绑定的Lease ID，这样在启动恢复的时候可以将两者对应的关系恢复到内存中。</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-lease-store.png" alt="etcd lease store"></p>
<p>明白了以上关系再来理解Lessor的实现就很简单了，lessor中主要包括以下的成员：</p>
<ul>
<li>leaseMap map[LeaseID]*Lease：存储LeaseID与Lease实例之间的对应关系。</li>
<li>itemMap map[LeaseItem]LeaseID：leaseItem实际存放的是键值，所以这个map管理的就是键值与Lease ID之间的对应关系。</li>
<li>b backend.Backend：持久化存储，每个Lease的持久化数据会写入名为“lease”的Bucket中。</li>
<li>minLeaseTTL int64：最小过期时间，设置给每个lease的过期时间不得小于这个数据。</li>
<li>expiredC chan []*Lease：通过这个channel通知外部有哪些Lease过期了。</li>
</ul>
<p>其他的就很简单了:</p>
<ul>
<li>lessor启动之后会运行一个goroutine协程，在这个协程里定期查询哪些Lease超时，超时的Lease将通过expiredC channel通知外部。</li>
<li>而针对Lease的CRUD操作，都需要进行加锁才能操作。</li>
</ul>
<hr>
<h3 id="4-5-KV接口"><a href="#4-5-KV接口" class="headerlink" title="4.5 KV接口"></a><p id="p4_5">4.5 KV接口</p></h3><p>有了以上的准备，可以开始分析数据存储相关的内容了。在etcd V3中，所有涉及到数据的存储，都会通过KV接口。</p>
<p>store结构体实现了KV接口，其中最重要的就是封装了前面提到的几个数据结构：</p>
<ul>
<li>b backend.Backend：用于将持久化数据写入BoltDB中。</li>
<li>kvindex index：保存key索引。</li>
<li>changes []mvccpb.KeyValue：保存每次写操作之后进行了修改的数据，用于通知watch了这些数据变更的客户端。</li>
</ul>
<p>在store结构体初始化时，根据传入的 backend.Backend，初始化 backend.BatchTx 结构，后面的任何涉及到事务的操作，都可以通过这个 backend.BatchTx 来进行。</p>
<p>其实有了前面的准备，理解store结构做的事情已经不难，以一次Put操作为例，其流程主要如下图所示：</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-store-put.png" alt="etcd store put"></p>
<hr>
<h2 id="5-applierV3"><a href="#5-applierV3" class="headerlink" title="5. applierV3"></a><p id="p5">5. applierV3</p></h2><p>EtcdServer 内部实现中，实际使用的是applierV3接口来进行持久化数据的操作。</p>
<p>这个接口有以下几个实现，但是其中applierV3backend的实现是最重要的，其内部使用了前面提到的KV接口来进行数据的处理。</p>
<p>另外，applierV3接口还有其他几个实现，这里分别列举一下：</p>
<ul>
<li>applierV3backend：基础的applierV3接口实现，其他几个实现都在此实现上做功能扩展。内部调用EtcdServer中的KV接口进行持久化数据读写操作。</li>
<li>applierV3Capped：磁盘空间不足的情况下，EtcdServer中的applierV3切换到这个实现里面来，这个实现的任何写入操作都会失败，这样保证底层存储的数据量不再增加。</li>
<li>authApplierV3：在applierV3backend的基础上扩展出权限控制的功能。</li>
<li>quotaApplierV3：在applierV3backend的基础上加上了限流功能，即底层的存储到了上限的话，会触发限流操作。</li>
</ul>
<hr>
<h2 id="6-综述"><a href="#6-综述" class="headerlink" title="6. 综述"></a><p id="p6">6. 综述</p></h2><p>下图将上面所提及到的关键数据结构串联起来，我们可以看到EtcdServer在收到Raft库通过Ready channel通知的可以持久化数据之后，都做了什么操作：</p>
<p><img src="/2022/01/19/%E4%BD%BF%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1/etcd-raft-flow.png" alt="etcd raft flow"></p>
<ol>
<li>raft库通过Ready Channel通知上层的raftNode哪些数据可以进行持久化。</li>
<li>raftNode启动之后也是会启动一个Goroutine来一直监听这个Ready Channel，以便收到可以持久化数据的通知。</li>
<li>raftNode在收到Ready数据之后，将首先写入WAL日志中。这里的WAL日志由storage结构体来管理，分为两大部分：WAL日志以及WAL快照文件数据Snapshotter，后者用来避免WAL文件一直增大。</li>
<li>raftNode在写WAL数据完成之后，通过apply Channel通知EtcdServer。</li>
<li>EtcdServer启动之后也是启动一个Goroutine来监听这个channel，以便收到可以持久化数据的通知。</li>
<li>EtcdServer通过调用applierV3接口来持久化数据。applierV3backend结构体实现applierV3接口, applierV3backend结构体实现applierV3接口，内部通过调用KV接口进行持久化操作。而在实现KV接口的store结构体中，treeIndex负责在内存中维护数据键值与revision的对应关系即keyIndex数据，Backend接口负责持久化数据，最后持久化的数据将落盘到BoltDB中。</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>使用etcd实现存储服务</p><p><a href="https://lameber1123.github.io/2022/01/19/使用etcd实现存储服务/">https://lameber1123.github.io/2022/01/19/使用etcd实现存储服务/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Lamber</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-01-19</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-10-17</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Raft/">Raft</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><a class="link-muted mr-2" rel="tag" href="/tags/etcd/">etcd</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/01/21/%E3%80%8AIn-Search-of-an-Understandable-Consensus-Algorithm%E3%80%8B%E7%BF%BB%E8%AF%91/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">《In Search of an Understandable Consensus Algorithm》译文</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/01/15/etcd-Raft%E5%BA%93%E8%A7%A3%E6%9E%90/"><span class="level-item">etcd Raft库解析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="Lamber"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Lamber</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Xi&#039;an, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">39</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">31</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/lamber1123" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/lamber1123"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://space.bilibili.com/167431968"><i class="iconfont icon-bilibili-fill"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/6859290371"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Zhihu" href="https://www.zhihu.com/people/lamber-51"><i class="iconfont icon-zhihu"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="WeiChat" href="/img/weixin.png"><i class="fab fa-weixin"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://Nancy0205.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Nancy的博客</span></span><span class="level-right"><span class="level-item tag">nancy0205.github.io</span></span></a></li><li><a class="level is-mobile" href="https://ecampus.nwpu.edu.cn/main.html#/Index" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">翱翔门户</span></span><span class="level-right"><span class="level-item tag">ecampus.nwpu.edu.cn</span></span></a></li><li><a class="level is-mobile" href="https://cnki.net/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">中国知网</span></span><span class="level-right"><span class="level-item tag">cnki.net</span></span></a></li><li><a class="level is-mobile" href="https://docs.pingcap.com/zh/tidb/stable/tikv-overview/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">PingCAP</span></span><span class="level-right"><span class="level-item tag">docs.pingcap.com</span></span></a></li><li><a class="level is-mobile" href="https://hardcore.feishu.cn/docs/doccnMRVFcMWn1zsEYBrbsDf8De#" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Raft讲稿</span></span><span class="level-right"><span class="level-item tag">hardcore.feishu.cn</span></span></a></li><li><a class="level is-mobile" href="https://liqul.github.io/blog/tags/Raft/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bucket&amp;Hammer</span></span><span class="level-right"><span class="level-item tag">liqul.github.io</span></span></a></li><li><a class="level is-mobile" href="https://www.codedump.info/post/20180922-etcd-raft/#%E8%BE%93%E5%85%A5%E5%8F%8A%E8%BE%93%E5%87%BA" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Raft源码解析</span></span><span class="level-right"><span class="level-item tag">www.codedump.info</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/opengauss/openGauss-server/blob/master/README.md" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">openGauss官方文档</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/CentOS/"><span class="level-start"><span class="level-item">CentOS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Raft%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">Raft笔记</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/TiKV%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">TiKV笔记</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/css%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">css笔记</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/hexo/"><span class="level-start"><span class="level-item">hexo</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/html%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">html笔记</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/icarus/"><span class="level-start"><span class="level-item">icarus</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/js%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">js笔记</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/openGauss/"><span class="level-start"><span class="level-item">openGauss</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%91%B8%E9%B1%BC/"><span class="level-start"><span class="level-item">摸鱼</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-12-07T11:56:58.000Z">2022-12-07</time></p><p class="title"><a href="/2022/12/07/DCFTest%EF%BC%9ADCF%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E7%9A%84%E8%AE%BE%E8%AE%A1/">DCFTest：DCF框架的测试工具</a></p><p class="categories"><a href="/categories/openGauss/">openGauss</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-17T07:59:47.000Z">2022-10-17</time></p><p class="title"><a href="/2022/10/17/%E8%85%BE%E8%AE%AF%E5%8F%AE%E5%BD%93%E9%9F%B3%E7%AE%B1%E5%88%B7%E5%85%A5Android8-1%E7%B3%BB%E7%BB%9F/">腾讯叮当音箱刷入Android8.1系统</a></p><p class="categories"><a href="/categories/%E6%91%B8%E9%B1%BC/">摸鱼</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-10T12:22:28.000Z">2022-10-10</time></p><p class="title"><a href="/2022/10/10/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%90%AF%E5%8A%A8OG%E7%9A%84DCF%E6%A8%A1%E5%9D%97/">服务器上启动OG的DCF模块</a></p><p class="categories"><a href="/categories/openGauss/">openGauss</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-05-06T13:52:30.000Z">2022-05-06</time></p><p class="title"><a href="/2022/05/06/openGauss%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/">openGauss存储技术</a></p><p class="categories"><a href="/categories/openGauss/">openGauss</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-04-18T08:20:22.000Z">2022-04-18</time></p><p class="title"><a href="/2022/04/18/openGauss%E7%9A%84DCF%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3/">openGauss的DCF组件详解</a></p><p class="categories"><a href="/categories/openGauss/">openGauss</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">December 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CentOS/"><span class="tag">CentOS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DCF/"><span class="tag">DCF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DCFTest/"><span class="tag">DCFTest</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Key-Value/"><span class="tag">Key-Value</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MVCC/"><span class="tag">MVCC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PD/"><span class="tag">PD</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Paxos/"><span class="tag">Paxos</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RPC/"><span class="tag">RPC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Raft/"><span class="tag">Raft</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Region/"><span class="tag">Region</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RocksDB/"><span class="tag">RocksDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQL/"><span class="tag">SQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TiDB/"><span class="tag">TiDB</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TiFlash/"><span class="tag">TiFlash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TiKV/"><span class="tag">TiKV</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VMware/"><span class="tag">VMware</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zab/"><span class="tag">Zab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zookeeper/"><span class="tag">Zookeeper</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/etcd/"><span class="tag">etcd</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/icarus/"><span class="tag">icarus</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ico/"><span class="tag">ico</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/js/"><span class="tag">js</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openGauss/"><span class="tag">openGauss</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%83%E4%BF%A1%E6%81%AF/"><span class="tag">元信息</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="tag">分布式</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB/"><span class="tag">映射关系</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Lamber&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Lamber</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/u/6859290371"><i class="fab fa-weibo"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="WeiChat" href="/img/weixin.png"><i class="fab fa-weixin"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/lamber1123"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>